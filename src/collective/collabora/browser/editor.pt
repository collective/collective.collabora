<tal:def define="
           error view/error;
         ">

  <div tal:condition="error">
    <h2 i18n:translate="label_error">Error</h2>
    <p i18n:translate="error">${error}</p>
  </div>

  <div tal:condition="python: not error">
    <p>
      <a href="${context/absolute_url}/view"
         i18n:translate=""
      >Close editor</a>
      |
      <a href="${view/wopi_url}&amp;access_token=${view/jwt_token}"
         target="_blank"
         i18n:translate=""
      >Open editor without iframe in new tab</a>
    </p>
  </div>

  <!-- to remove: frameborder for debugging -->
  <iframe tal:condition="python: not error"
          allowfullscreen="true"
          id="collabora_iframe"
          frameborder="1"
          height="100%"
          scrolling="no"
          src="${view/wopi_url}&amp;access_token=${view/jwt_token}"
          width="100%"
    ></iframe>

    <script type="text/javascript">
     function handlePostMessage(e) {
         // The actual message is contained in the data property of the event.
         var msg = JSON.parse(e.data);

         // The message ID is now a property of the message object.
         var msgId = msg.MessageId;

         // The message parameters themselves are in the Values
         // parameter on the message object.
         var msgData = msg.Values;

         // Do something with the message here.
         console.log('Received message: ' + msgId);
         console.log(msgData);

         if (msgData.Status == 'Document_Loaded') {
             console.log("Resizing iframe on document loaded");
             var iframe = document.getElementById("collabora_iframe");
             var offset = iframe.offsetTop + 5;
             iframe.style.height = 'calc(100vh - ' + offset  + 'px)';
         }

     }

     window.addEventListener('message', handlePostMessage, false);
    </script>

</tal:def>
